version: 2
jobs:
  harness-image-build:
    machine: true
    steps:
      - checkout
      - run:
          name: Build harness image
          command: |
            cd ${HOME}/project
            docker build -t harness:local harness
            docker tag harness:local gcr.io/sp-ml-infra/spotify-tensorflow-worker-harness-tfdv:latest
            docker tag harness:local gcr.io/sp-ml-infra/spotify-tensorflow-worker-harness-tfdv:$(git rev-parse --short HEAD)
      - deploy:
          name: Push harness image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              # Auth
              cd ${HOME}/project
              SP_ML_INFRA_ENC_PASS="$SP_ML_INFRA_ENC_PASS" harness/bin/decrypt harness/sp-ml-infra-38fdc61438b2.json.enc
              gcloud auth activate-service-account --key-file harness/sp-ml-infra-38fdc61438b2.json.unenc
              gcloud --quiet config set project sp-ml-infra

              # Push
              gcloud docker -- push gcr.io/sp-ml-infra/spotify-tensorflow-worker-harness-tfdv:$(git rev-parse --short HEAD)
              gcloud docker -- push gcr.io/sp-ml-infra/spotify-tensorflow-worker-harness-tfdv:latest
            fi
  test-python3:
    docker:
      - image: circleci/python:3.6.1
      
    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements-mypy.txt" }}
          - v1-dependencies-

      - run:
          name: Run Tests
          command: |
            sudo pip install tox
            tox -e mypy

      - save_cache:
          paths:
            - ./.tox/py36
          key: v1-dependencies-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements-mypy.txt" }}

      - run:
          name: Upload Coverage
          command: |
            pip install --user codecov
            python -m codecov

  test-python2:
    docker:
      - image: circleci/python:2.7.14

    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
          - v1-dependencies-py2-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements.txt" }}
          - v1-dependencies-py2-

      - run:
          name: Run Tests
          command: |
            sudo pip install tox
            tox -e py27

      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-py2-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements.txt" }}

      - run:
          name: Upload Coverage
          command: |
            pip install --user codecov
            python -m codecov
workflows:
  version: 2
  test:
    jobs:
      - test-python3
      - test-python2
      - harness-image-build
